<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: Algorithms::Rank::Elo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">Algorithms::Rank::Elo</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/lib/algorithms/rank/elo_rb.html">
                lib/algorithms/rank/elo.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000107">adjust_elo</a>&nbsp;&nbsp;
      <a href="#M000108">expected_score</a>&nbsp;&nbsp;
      <a href="#M000109">k_value</a>&nbsp;&nbsp;
      <a href="#M000106">score</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">START_RATING</td>
          <td>=</td>
          <td class="context-item-value">1400</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">K_VALUE</td>
          <td>=</td>
          <td class="context-item-value">32</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DRAW_SCORE</td>
          <td>=</td>
          <td class="context-item-value">0.5</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">LOSS_SCORE</td>
          <td>=</td>
          <td class="context-item-value">0</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">WIN_SCORE</td>
          <td>=</td>
          <td class="context-item-value">1</td>
        </tr>
        </table>
      </div>
    </div>



      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000107" class="method-detail">
        <a name="M000107"></a>

        <div class="method-heading">
          <a href="#M000107" class="method-signature">
          <span class="method-name">adjust_elo</span><span class="method-args">(score, r_A, r_B)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This value is added to the previous <a href="Elo.html">Elo</a> <a
href="Elo.html#M000106">score</a> to obtain the current <a
href="Elo.html#M000106">score</a>.
</p>
<h4>Return</h4>
<p>
Integer which is the amount by which to adjust the <a
href="Elo.html">Elo</a> <a href="Elo.html#M000106">score</a>
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top"><a href="Elo.html#M000106">score</a>&lt;int&gt;:</td><td>The adjustment value for a win, loss, or draw.

</td></tr>
<tr><td valign="top">r_A&lt;int&gt;:</td><td>The <a href="Elo.html">Elo</a> <a href="Elo.html#M000106">score</a> of the
item whose <a href="Elo.html#M000106">score</a> to be adjusted.

</td></tr>
<tr><td valign="top">r_B&lt;int&gt;:</td><td>The <a href="Elo.html">Elo</a> <a href="Elo.html#M000106">score</a> of the
item whhose <a href="Elo.html#M000106">score</a> is not being adjusted.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000107-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000107-source">
<pre>
    <span class="ruby-comment cmt"># File lib/algorithms/rank/elo.rb, line 75</span>
75:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">adjust_elo</span>(<span class="ruby-identifier">score</span>, <span class="ruby-identifier">r_A</span>, <span class="ruby-identifier">r_B</span>)
76:     <span class="ruby-identifier">k_value</span>(<span class="ruby-identifier">r_A</span>) <span class="ruby-operator">*</span> (<span class="ruby-identifier">score</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">expected_score</span>(<span class="ruby-identifier">r_A</span>, <span class="ruby-identifier">r_B</span>))
77:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000108" class="method-detail">
        <a name="M000108"></a>

        <div class="method-heading">
          <a href="#M000108" class="method-signature">
          <span class="method-name">expected_score</span><span class="method-args">(r_A, r_B)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The <a href="Elo.html#M000106">score</a> if A plays B.
</p>
<h4>Return</h4>
<p>
Integer of the expected <a href="Elo.html#M000106">score</a>.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">r_A&lt;int&gt;:</td><td>The <a href="Elo.html">Elo</a> <a href="Elo.html#M000106">score</a> of item
A.

</td></tr>
<tr><td valign="top">r_B&lt;int&gt;:</td><td>The <a href="Elo.html">Elo</a> <a href="Elo.html#M000106">score</a> of item
B.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000108-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000108-source">
<pre>
    <span class="ruby-comment cmt"># File lib/algorithms/rank/elo.rb, line 85</span>
85:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">expected_score</span>(<span class="ruby-identifier">r_A</span>, <span class="ruby-identifier">r_B</span>)
86:     <span class="ruby-value">1</span> <span class="ruby-operator">/</span> (<span class="ruby-value">1</span> <span class="ruby-operator">+</span> <span class="ruby-value">10</span><span class="ruby-operator">**</span>((<span class="ruby-identifier">r_B</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">r_A</span>) <span class="ruby-operator">/</span> <span class="ruby-value">400.0</span>))
87:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000109" class="method-detail">
        <a name="M000109"></a>

        <div class="method-heading">
          <a href="#M000109" class="method-signature">
          <span class="method-name">k_value</span><span class="method-args">(r_A)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Calculate the K value for an item based on if an adjusted algorithm is
being used and the <a href="Elo.html#M000106">score</a> of the item
</p>
<h4>Return</h4>
<p>
The K value for an item.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">r_A&lt;int&gt;:</td><td>The <a href="Elo.html#M000106">score</a> of the item whose K value is to be
generated.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000109-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000109-source">
<pre>
     <span class="ruby-comment cmt"># File lib/algorithms/rank/elo.rb, line 95</span>
 95:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">k_value</span>(<span class="ruby-identifier">r_A</span>)
 96:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@adj</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">r_A</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2100</span>
 97:       <span class="ruby-constant">K_VALUE</span>
 98:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">r_A</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2400</span>
 99:       <span class="ruby-value">16</span>
100:     <span class="ruby-keyword kw">else</span>
101:       <span class="ruby-value">24</span>
102:     <span class="ruby-keyword kw">end</span>
103:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000106" class="method-detail">
        <a name="M000106"></a>

        <div class="method-heading">
          <a href="#M000106" class="method-signature">
          <span class="method-name">score</span><span class="method-args">(user_id, order, question_id, limit, adj=true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Calculate <a href="Elo.html">Elo</a> <a href="Elo.html#M000106">score</a>
for all items given a user and question.
</p>
<h4>Return</h4>
<p>
Array of item IDs, followed by an array of <a href="Elo.html">Elo</a>
scores matching to the item with the same array index.
</p>
<h4>Parameters</h4>
<table>
<tr><td valign="top">user_id&lt;int&gt;:</td><td>Get <a href="Elo.html">Elo</a> scores for user with this ID.

</td></tr>
<tr><td valign="top">order&lt;string&gt;:</td><td>If &#8216;asc&#8217; return <a href="Elo.html">Elo</a> scores in ascending
order, otherwise

</td></tr>
</table>
<p>
return <a href="Elo.html">Elo</a> scores in descending order.
</p>
<table>
<tr><td valign="top">question_id&lt;int&gt;:</td><td>Get <a href="Elo.html">Elo</a> scores for items in this question.

</td></tr>
<tr><td valign="top">limit&lt;int&gt;:</td><td>Truncate scores returned to this number of items.

</td></tr>
<tr><td valign="top">adj&lt;bool&gt;:</td><td>Use an adjusted <a href="Elo.html">Elo</a> algorithm. Default true.

</td></tr>
</table>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000106-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000106-source">
<pre>
    <span class="ruby-comment cmt"># File lib/algorithms/rank/elo.rb, line 19</span>
19:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">score</span>(<span class="ruby-identifier">user_id</span>, <span class="ruby-identifier">order</span>, <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">limit</span>, <span class="ruby-identifier">adj</span>=<span class="ruby-keyword kw">true</span>)
20:     <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN users ON items.user_id=#{user_id}&quot;</span>
21:     <span class="ruby-identifier">joins</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; INNER JOIN items_questions ON (items_questions.question_id=#{question_id} AND items_questions.item_id=items.id)&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">question_id</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
22:     <span class="ruby-identifier">conditions</span> = {
23:       <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">joins</span>,
24:       <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'items.id'</span>
25:     }
26:     <span class="ruby-identifier">items</span> = <span class="ruby-constant">Item</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">conditions</span>)
27: 
28:     <span class="ruby-identifier">conditions</span> = {
29:       <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:active</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span> },
30:       <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'prompts.created_at'</span>,
31:       <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:items</span>, <span class="ruby-identifier">:votes</span>],
32:       <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'prompts.id'</span>
33:     }
34:     <span class="ruby-identifier">conditions</span>[<span class="ruby-identifier">:conditions</span>].<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">question_id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
35:     <span class="ruby-identifier">prompts</span> = <span class="ruby-constant">Prompt</span>.<span class="ruby-identifier">all</span>(<span class="ruby-identifier">conditions</span>)
36: 
37:     <span class="ruby-identifier">elo</span> = {}
38:     <span class="ruby-identifier">items</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> <span class="ruby-identifier">elo</span>[<span class="ruby-identifier">item</span>] = <span class="ruby-constant">START_RATING</span> }
39:     <span class="ruby-ivar">@adj</span> = <span class="ruby-identifier">adj</span>
40:     <span class="ruby-identifier">prompts</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">prompt</span><span class="ruby-operator">|</span>
41:       <span class="ruby-identifier">prompt</span>.<span class="ruby-identifier">votes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vote</span><span class="ruby-operator">|</span>
42:         <span class="ruby-comment cmt"># elo values static during update</span>
43:         <span class="ruby-identifier">old_elo</span> = <span class="ruby-identifier">elo</span>.<span class="ruby-identifier">clone</span>
44:         <span class="ruby-comment cmt"># if vote has items it has winner(s)</span>
45:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">vote</span>.<span class="ruby-identifier">items</span>.<span class="ruby-identifier">empty?</span>
46:           <span class="ruby-identifier">vote</span>.<span class="ruby-identifier">items</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
47:             <span class="ruby-identifier">lost_items</span> = <span class="ruby-identifier">prompt</span>.<span class="ruby-identifier">items</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vote</span>.<span class="ruby-identifier">items</span>
48:             <span class="ruby-identifier">lost_items</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">loser</span><span class="ruby-operator">|</span>
49:               <span class="ruby-identifier">elo</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">adjust_elo</span>(<span class="ruby-constant">WIN_SCORE</span>, <span class="ruby-identifier">old_elo</span>[<span class="ruby-identifier">item</span>], <span class="ruby-identifier">elo</span>[<span class="ruby-identifier">loser</span>])
50:               <span class="ruby-identifier">elo</span>[<span class="ruby-identifier">loser</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">adjust_elo</span>(<span class="ruby-constant">LOSS_SCORE</span>, <span class="ruby-identifier">elo</span>[<span class="ruby-identifier">loser</span>], <span class="ruby-identifier">old_elo</span>[<span class="ruby-identifier">item</span>])
51:             <span class="ruby-keyword kw">end</span>
52:           <span class="ruby-keyword kw">end</span>
53:         <span class="ruby-keyword kw">else</span>
54:           <span class="ruby-comment cmt"># otherwise consider as draw between all prompt items</span>
55:           <span class="ruby-identifier">prompt</span>.<span class="ruby-identifier">items</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span>
56:             (<span class="ruby-identifier">prompt</span>.<span class="ruby-identifier">items</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">item</span>]).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">other</span><span class="ruby-operator">|</span>
57:               <span class="ruby-identifier">elo</span>[<span class="ruby-identifier">item</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">adjust_elo</span>(<span class="ruby-constant">DRAW_SCORE</span>, <span class="ruby-identifier">elo</span>[<span class="ruby-identifier">item</span>], <span class="ruby-identifier">old_elo</span>[<span class="ruby-identifier">other</span>])
58:             <span class="ruby-keyword kw">end</span>
59:           <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># item_ids each</span>
60:         <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># else</span>
61:       <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># votes each</span>
62:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># prompts each</span>
63:     <span class="ruby-identifier">elo</span> = (<span class="ruby-identifier">order</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;asc&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">elo</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span> } <span class="ruby-operator">:</span> <span class="ruby-identifier">elo</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-operator">-</span><span class="ruby-identifier">v</span> }
64:     <span class="ruby-identifier">elo</span> = <span class="ruby-identifier">elo</span>.<span class="ruby-identifier">first</span>(<span class="ruby-identifier">limit</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">limit</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
65:     <span class="ruby-identifier">elo</span>.<span class="ruby-identifier">transpose</span>
66:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>